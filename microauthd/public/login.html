<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>microauthd Login</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="/style.css">
    <script defer>
    // Parse query params into hidden inputs
    async function setQueryParams() {
        const jti = new URLSearchParams(window.location.search).get("jti");
        if (!jti) return;

        try {
            const input = document.createElement("input");
            input.type = "hidden";
            input.name = "jti";
            input.value = jti;
            document.getElementById("loginForm").appendChild(input);

            const res = await fetch(`/auth_session/${jti}`);
            if (!res.ok) throw new Error("Unable to load session");

            const data = await res.json();
            const qs = new URLSearchParams(data.query_string);

            for (const name of ['client_id', 'redirect_uri', 'state', 'nonce', 'code_challenge', 'code_challenge_method', 'scope']) {
                const val = qs.get(name);
                if (val) {
                    const input = document.createElement('input');
                    input.type = 'hidden';
                    input.name = name;
                    input.value = val;
                    document.getElementById('loginForm').appendChild(input);
                }
            }
        } catch (err) {
            console.error("Failed to fetch session data:", err);
        }
    }

    // Handle CSRF token
    async function fetchCsrfToken() {
      const res = await fetch('/antiforgery', { credentials: 'include' });
      const token = await res.text();
      document.getElementById('csrf').value = token;
    }

    window.addEventListener('DOMContentLoaded', () => {
      fetchCsrfToken();
    });
    </script>
</head>
<body onload="setQueryParams()">
    <div class="login-container">
        <h2>Login</h2>
        <form id="loginForm" method="post" action="/login-ui">
            <input type="hidden" name="__RequestVerificationToken" id="csrf" value="">
            <label>
                Username:
                <input type="text" name="username" required autofocus>
            </label>
            <label>
                Password:
                <input type="password" name="password" required>
            </label>
            <button type="submit">Sign In</button>
        </form>
        <p id="error" style="color: red;"></p>
    </div>
</body>
</html>
