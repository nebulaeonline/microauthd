<!DOCTYPE html>
<html>
<head>
    <title>microauthd Login</title>
    <link rel="stylesheet" href="style.css" />
    <script src="pkce.js"></script>
</head>
<body>
    <h2>Login</h2>
    <form id="loginForm">
        <input type="text" id="username" placeholder="Username" required />
        <input type="password" id="password" placeholder="Password" required />
        <input type="text" id="client_id" placeholder="Client ID" value="demo" required />
        <button type="submit">Log In</button>
    </form>
    <pre id="output"></pre>

    <script>

    let csrfToken = "";

    async function loadCsrfToken() {
        const res = await fetch("/antiforgery", {
            credentials: "include"
        });

        if (res.ok) {
            csrfToken = await res.text();
        } else {
            throw new Error("Failed to fetch CSRF token");
        }
    }

    const form = document.getElementById("loginForm");
    const output = document.getElementById("output");

    form.onsubmit = async (e) => {
      e.preventDefault();

      try {
          await loadCsrfToken(); // get CSRF token before login
      } catch (err) {
          output.textContent = "CSRF error: " + err.message;
          return;
      }

      const urlsearchparams = new URLSearchParams(location.search);
      const username = document.getElementById("username").value;
      const password = document.getElementById("password").value;
      const client_id = document.getElementById("client_id").value;
      const code = urlsearchparams.get("code");
      const redirect_uri = "http://localhost:9040/pkce_demo/login.html";
      const code_verifier = sessionStorage.getItem("pkce_verifier");
      const scope = urlsearchparams.get("scope");
      const nonce = urlsearchparams.get("nonce");

      if (!code || !code_verifier) {
        output.textContent = "Missing code or code_verifier.";
        return;
      }

      const formData = new URLSearchParams({
        username,
        password,
        client_id,
        code,
        redirect_uri,
          code_verifier,
          scope,
          nonce,
      });

      try {
        const res = await fetch("/login", {
          method: "POST",
          credentials: "include",
          headers: {
            "Content-Type": "application/x-www-form-urlencoded",
            "X-CSRF-TOKEN": csrfToken
          },
          body: formData
        });

        const data = await res.json();
        if (!res.ok) throw new Error(data.message || "Login failed");

        const tokenRes = await fetch("/token", {
          method: "POST",
          headers: { "Content-Type": "application/x-www-form-urlencoded" },
          body: new URLSearchParams({
            grant_type: "authorization_code",
            client_id,
            code,
            redirect_uri,
            code_verifier
           })
        });

        const token = await tokenRes.json();
        if (!token.access_token) throw new Error("Token exchange failed");

        output.textContent = JSON.stringify(token, null, 2);

        const me = await fetch("/me", {
          headers: { Authorization: "Bearer " + token.access_token }
        }).then(r => r.json());

        output.textContent += "\n\n" + JSON.stringify(me, null, 2);
      } catch (err) {
        output.textContent = err.message;
      }
    };
    </script>
</body>
</html>